# MongoDB存储引擎分析

## 1. 引言与架构概述

MongoDB是一款流行的NoSQL数据库，其存储引擎负责数据的持久化与检索。MongoDB支持多种存储引擎，最常用的是WiredTiger。存储引擎的选择直接影响数据库的性能、事务支持和数据一致性。

MongoDB的架构包括：
- 客户端驱动
- mongod服务进程
- 存储引擎接口（Storage Engine API）
- 实际存储引擎实现

## 2. 存储引擎类型

MongoDB支持多种存储引擎：
- **MMAPv1（已弃用）**：基于内存映射文件，支持文档级锁。
- **WiredTiger（默认）**：支持多版本并发控制（MVCC）、压缩和事务。
- **In-Memory**：数据仅存储在内存中，适用于高性能场景。
- **RocksDB（社区支持）**：基于LSM树，适合写密集型应用。

## 3. WiredTiger存储引擎详解

WiredTiger是MongoDB 3.2后默认的存储引擎，具备如下特性：
- 支持文档级并发控制
- 数据压缩（Snappy、zlib等）
- 支持ACID事务（4.0版本后）
- 多版本并发控制（MVCC）

主要模块包括：
- 缓冲池管理（Cache）
- 日志与检查点（Journal & Checkpoint）
- B+树索引实现

## 4. 索引与数据结构

MongoDB的索引主要采用B+树结构，支持单字段、复合字段、哈希、地理空间等多种索引类型。WiredTiger将每个集合和索引存储为独立的文件，便于管理和优化。

## 5. 数据一致性与事务

MongoDB在WiredTiger引擎下支持多文档事务，采用WiredTiger的MVCC机制实现快照隔离。写操作先写入内存和预写日志（WAL），定期做检查点保证数据持久化。

## 6. 写入流程与优化

写入流程：
1. 客户端发送写请求
2. 数据写入内存和预写日志
3. 达到条件后触发检查点，将内存数据刷盘
4. 日志定期清理

优化建议：
- 合理配置缓存大小
- 调整检查点和日志参数
- 使用合适的压缩算法

## 7. 常见问题与源码阅读建议

常见问题：
- 写放大：频繁的写操作导致磁盘IO压力大
- 索引膨胀：大量索引导致存储空间浪费

源码阅读建议：
- 关注`src/mongo/db/storage/wiredtiger/`目录
- 入口类：`WiredTigerKVEngine`
- 事务实现：`WiredTigerSession`

## 8. 总结

MongoDB的存储引擎设计兼顾了性能、灵活性和事务支持。深入理解其原理有助于更好地优化和使用MongoDB。
