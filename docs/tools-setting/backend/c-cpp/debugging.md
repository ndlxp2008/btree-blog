# C/C++ 调试指南 (GDB + VS Code)

调试是软件开发过程中定位和修复错误的关键环节。对于使用 GCC 工具链 (如 MinGW-w64) 开发的 C/C++ 程序，GDB (GNU Debugger) 是标准的调试工具。结合 VS Code 强大的调试界面，可以大大提高调试效率。

**前提条件:**

*   已按照 [GCC 编译器安装与配置](/tools-setting/backend/c-cpp/gcc-setup.md) 安装了 GDB。
*   已按照 [VSCode C/C++ 开发环境配置](/tools-setting/backend/c-cpp/vscode-cpp-setup.md) 配置好了 VS Code 的构建任务 (`tasks.json`) 和调试配置 (`launch.json`)。
*   **编译时必须包含调试信息:** 确保你的编译命令 (在 `tasks.json` 或 CMake 配置中) 包含了 `-g` 标志。没有 `-g` 编译的程序无法进行有效的源代码级调试。
    ```json
    // tasks.json (示例片段)
    "args": [
        "-g", // <-- 必需！
        "${file}",
        "-o",
        "${fileDirname}\\${fileBasenameNoExtension}.exe"
    ]
    ```
    ```cmake
    # CMakeLists.txt (Debug 构建类型通常会自动添加 -g)
    # 或者手动添加编译选项
    # target_compile_options(my_target PRIVATE "$<$<CONFIG:Debug>:-g>")
    ```

## 1. VS Code 调试界面简介

当你启动调试会话 (按 `F5` 或点击 "运行和调试" 视图中的启动按钮) 时，VS Code 会进入调试模式，界面会发生一些变化：

*   **调试工具栏:** 出现在编辑器顶部，包含继续/暂停、单步跳过、单步进入、单步跳出、重启、停止等按钮。
*   **变量 (Variables) 窗口:** (通常在左侧边栏) 显示当前作用域内的局部变量、全局变量和寄存器。你可以展开对象和数组查看其内容。
*   **监视 (Watch) 窗口:** (左侧边栏) 允许你添加表达式或变量名，调试器会在每次暂停时计算并显示它们的值。
*   **调用堆栈 (Call Stack) 窗口:** (左侧边栏) 显示当前的函数调用链。点击不同的堆栈帧可以切换上下文，查看该函数调用时的变量状态。
*   **断点 (Breakpoints) 窗口:** (左侧边栏) 列出你设置的所有断点，可以启用/禁用或编辑断点条件。
*   **调试控制台 (Debug Console) REPL:** (底部面板) 显示程序的输出 (`stdout`, `stderr`)，并允许你直接输入 GDB 命令与调试器交互。

## 2. 调试基本操作

### 设置断点

*   **普通断点:** 在代码编辑器的行号左侧单击，会出现一个红点。当程序执行到这一行时，调试器会暂停。
*   **条件断点:** 右键单击红点，选择 "编辑断点 (Edit Breakpoint)"。在弹出的输入框中，选择 "表达式 (Expression)"，然后输入一个条件表达式 (例如 `count > 10` 或 `name == "error"`)。只有当该表达式为真时，程序才会在该断点处暂停。
*   **日志断点 (Logpoints):** 右键单击行号左侧空白处，选择 "添加日志断点 (Add Logpoint)"。输入要打印的消息，可以使用花括号 `{}` 嵌入表达式 (例如 `循环变量 i 的值是: {i}`)。程序执行到该行时，不会暂停，但会在调试控制台输出你指定的消息。
*   **函数断点:** 在断点窗口点击 "+" 号，输入函数名 (例如 `myFunction`)。程序在进入该函数时会暂停。

### 启动调试

1.  确保选择了正确的启动配置 (在 "运行和调试" 视图顶部的下拉菜单中，通常是 `(gdb) Launch` 或类似名称)。
2.  按 `F5` 或点击绿色的播放按钮。
3.  VS Code 会先执行 `preLaunchTask` (编译你的代码，确保它是最新的并且带 `-g`)，然后启动 GDB 并附加到你的程序上。
4.  如果设置了断点，程序会在第一个命中的断点处暂停。

### 控制执行流程 (调试工具栏)

*   **继续 (Continue, F5):** 让程序继续运行，直到遇到下一个断点或程序结束。
*   **暂停 (Pause, F6):** (当程序在运行时) 手动暂停程序执行。
*   **单步跳过 (Step Over, F10):** 执行当前行。如果当前行包含函数调用，则执行该函数，但**不**进入函数内部，直接停在下一行。
*   **单步进入 (Step Into, F11):** 执行当前行。如果当前行包含函数调用，则进入该函数内部的第一行暂停。
*   **单步跳出 (Step Out, Shift+F11):** 继续执行当前函数剩余的部分，直到函数返回，然后停在调用该函数处的下一行。
*   **重启 (Restart, Ctrl+Shift+F5):** 重新启动当前的调试会话。
*   **停止 (Stop, Shift+F5):** 终止调试会话。

## 3. 检查程序状态

### 变量窗口

*   当程序暂停时，"变量" 窗口会自动显示当前函数作用域内的局部变量。
*   你可以展开复杂类型 (结构体、类、指针、数组) 查看其成员或元素。
*   将鼠标悬停在编辑器中的变量名上，通常也会弹出一个小窗口显示其当前值。

### 监视窗口

*   点击 "监视" 窗口标题栏的 "+" 号。
*   输入你想持续观察的变量名或表达式 (例如 `data[i]`, `user.name`, `x * 2 + y`)。
*   调试器会在每次暂停时重新计算并显示这些表达式的值。
*   这对于跟踪特定变量的变化或查看复杂表达式的结果非常有用。

### 调用堆栈窗口

*   显示函数调用的顺序，最近调用的函数在顶部。
*   点击堆栈中的某个函数名，VS Code 会跳转到该函数的调用位置，并且 "变量" 窗口会更新以显示该函数调用时的局部变量状态。这对于理解代码是如何执行到当前位置的非常有帮助。

### 调试控制台

*   **查看程序输出:** 程序通过 `printf`, `std::cout` 等打印的信息会显示在这里。
*   **执行 GDB 命令:** 你可以直接在调试控制台中输入 GDB 命令。在输入前加上 `-exec` 前缀，例如：
    *   `-exec p myVariable` : 打印变量 `myVariable` 的值 (等同于 `print myVariable`)。
    *   `-exec info locals` : 显示当前栈帧的所有局部变量。
    *   `-exec bt` : 显示当前的调用堆栈 (等同于 `backtrace`)。
    *   `-exec continue` : 继续执行 (等同于 `c`)。
    *   `-exec step` : 单步进入 (等同于 `s`)。
    *   `-exec next` : 单步跳过 (等同于 `n`)。
*   **修改变量值:** `-exec set var myVariable = newValue` (例如 `-exec set var count = 0`)

## 4. 常见调试场景与技巧

*   **段错误 (Segmentation Fault):**
    *   程序通常会在导致错误的那一行崩溃。启动调试，让程序运行至崩溃。
    *   查看 "调用堆栈" 确定崩溃发生在哪个函数。
    *   检查 "变量" 窗口或使用调试控制台打印相关指针和变量的值，通常是由于访问了空指针、无效内存地址或数组越界导致的。
*   **死循环:**
    *   启动调试。
    *   当程序看起来卡住时，点击调试工具栏的 "暂停" 按钮。
    *   检查 "调用堆栈"，看程序停留在哪个循环中。
    *   检查循环条件和相关变量的值，找出循环无法退出的原因。
*   **逻辑错误 (结果不符合预期):**
    *   在关键计算步骤前后设置断点或日志断点。
    *   单步执行，检查每一步之后变量的值是否符合预期。
    *   使用 "监视" 窗口跟踪关键变量的变化。
*   **使用断言 (Assertions):**
    *   在代码中加入断言 (`assert(condition);`，需要 `#include <cassert>`) 来检查程序运行过程中的不变量或假设是否成立。
    *   如果断言失败，程序会终止并报告错误位置。在 Debug 构建中启用断言，在 Release 构建中通常会禁用 (`NDEBUG` 宏)。
*   **"Printf 调试":**
    *   虽然 GDB 功能强大，但有时最简单的方法是在代码中插入打印语句 (`printf`, `std::cout`) 来输出变量值或执行流程标记。调试结束后记得移除或注释掉这些语句。

掌握 GDB 和 VS Code 的调试功能需要实践。尝试在你自己的项目中设置断点、单步执行并观察变量，是学习调试的最佳方式。
